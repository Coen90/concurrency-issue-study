## í•´ê²° ë°©ë²• 2. Database ì´ìš©í•´ë³´ê¸°

### 2-1. Pessimistic Lock(ë¹„ë‚™ê´€ì  ë½) í™œìš©í•˜ê¸°

**ì‹¤ì œë¡œ ë°ì´í„°ì— ë½(Lock)ì„ ê±¸ì–´ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤. ë°°íƒ€(exclusive) ë½ì„ ê±¸ê²Œë˜ë©´, ë½ì´ í•´ì œë˜ê¸° ì „ì—ëŠ” ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ê°ˆ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.

```java
// StockService.class
public void decrease(Long if, Long quantity) {
  Stock stock = stockRepository.findById(id).orElseThrow(); // (1)
  stock.decrease(quantity); // (2)
}
```

- ìŠ¤ë ˆë“œ Aê°€ (1)ì„ ìˆ˜í–‰í•  ë•Œ, ë½ì„ ê±¸ê²Œë©ë‹ˆë‹¤.
- ìŠ¤ë ˆë“œ Bê°€ (1)ì„ ìˆ˜í–‰í•˜ë ¤ í•˜ì§€ë§Œ, ë½ì„ íšë“í•  ìˆ˜ ì—†ì–´ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤. (ì´ë¯¸ ìŠ¤ë ˆë“œ Aê°€ ë½ì„ ì ìœ  ì¤‘)
- ìŠ¤ë ˆë“œ Aê°€ (2)ê¹Œì§€ ì§„í–‰í•œ ë’¤, ë½ì„ í•´ì œí•©ë‹ˆë‹¤.
- ìŠ¤ë ˆë“œ Bê°€ ë½ì„ íšë“í•œ ë’¤, (1)~(2)ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### Pessimistic Lockì„ ì‹¤ì œ ì½”ë“œì— ì ìš©

```java
// StockRepository.class
public interface StockRepository extends JpaRepository<Stock, Long> {
  @Lock(LockModeType.PESSIMISTIC_WRITE)
  @Query("select s from Stock s where s.id = :id")
  Stock findByIdWithPessimisticLock(Long id);
}

// StockService.class
@Transactional
public void decrease(Long if, Long quantity) {
  Stock stock = stockRepository.findByIdWithPessimisticLock(id).orElseThrow();
  stock.decrease(quantity);
}
```

- PESSIMISTIC_WRITEëŠ” **í•´ë‹¹ ì—”í„°í‹°ì— ëŒ€í•œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ì“°ê¸° ë° ì½ê¸° ì‘ì—…ì„ ëª¨ë‘ ë§‰ëŠ” ë½ ë°©ì‹**ì…ë‹ˆë‹¤.
- `findByIdWithPessimisticLock()` ë©”ì„œë“œ í˜¸ì¶œë¶€í„° decrease ë©”ì„œë“œê°€ ëë‚˜ì„œ **íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ìˆœê°„ê¹Œì§€ ë½ì´ ìœ ì§€**ë©ë‹ˆë‹¤. (ë˜ëŠ” ë¡¤ë°± ë  ë•Œê¹Œì§€)

**â—ï¸** Pessimistic Lockì€ ë½ì´ ê±¸ë ¤ ìˆëŠ” ë™ì•ˆ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ë ¤ëŠ” ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ****ëŒ€ê¸° ìƒíƒœì— ë“¤ì–´ê°€ë¯€ë¡œ, **ë°ë“œë½(deadlock) ë¬¸ì œì— ìœ ì˜**í•´ì•¼ í•©ë‹ˆë‹¤.

ğŸ’¡Â ë”°ë¼ì„œ, **í•„ìš”í•œ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì§§ê²Œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ê³„**í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

ğŸ’¡Â ì¼ë°˜ì ìœ¼ë¡œ **ë°ì´í„° ê²½í•©ì´ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚  ê²ƒìœ¼ë¡œ ì˜ˆìƒë  ë•Œ** ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

ğŸ’¡Â ë½ ëŒ€ê¸°ëŠ” ë¬´í•œì • ì§€ì†ë˜ì§€ ì•Šë„ë¡, íƒ€ì„ì•„ì›ƒ(timeout)ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

</br>

### 2-2. Optimistic Lock(ë‚™ê´€ì  ë½) í™œìš©í•˜ê¸°

ì‹¤ì œë¡œ ë½ì„ ì´ìš©í•˜ì§€ ì•Šê³  **ë²„ì „ì„ ì´ìš©í•¨ìœ¼ë¡œì¨ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì½ì€ í›„ updateë¥¼ ìˆ˜í–‰í•  ë•Œ ë²„ì „ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ì—¬ ì—…ë°ì´íŠ¸ë¥¼ í•©ë‹ˆë‹¤. ë²„ì „ì´ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°, ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì¬ì‹œë„ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

```java
// StockService.class
public void decrease(Long if, Long quantity) {
  Stock stock = stockRepository.findById(id).orElseThrow(); // (1)
  stock.decrease(quantity); // (2)
}
```

- ìŠ¤ë ˆë“œ Aê°€ (1)ì„ ì§„í–‰í•˜ë©´ì„œ, ë²„ì „ ì •ë³´(ex. 1)ë¥¼ í•¨ê»˜ ì¡°íšŒí•©ë‹ˆë‹¤.
- ìŠ¤ë ˆë“œ Bê°€ (1)ì„ ì§„í–‰í•˜ë©´ì„œ, ë²„ì „ ì •ë³´(ex. 1)ë¥¼ í•¨ê»˜ ì¡°íšŒí•©ë‹ˆë‹¤.
- ìŠ¤ë ˆë“œ Aê°€ (2)ë¥¼ ì§„í–‰í•˜ë©´ì„œ, ë²„ì „ ì •ë³´(ex. 1)ë¥¼ í•¨ê»˜ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤. (ì—…ë°ì´íŠ¸ í›„ ë ˆì½”ë“œì˜ ë²„ì „ì´ 2ê°€ ë¨)
- ìŠ¤ë ˆë“œ Bê°€ (2)ë¥¼ ì§„í–‰í•˜ë©´ì„œ, ë²„ì „ ì •ë³´(ex. 1)ë¥¼ í•¨ê»˜ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ë²„ì „ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ (ë²„ì „ 1ì¸ ë ˆì½”ë“œë¥¼ ì—…ë°ì´íŠ¸ í•˜ë ¤ í•˜ì§€ë§Œ ë ˆì½”ë“œ ë²„ì „ì´ 2ì„) ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤.

### Optimistic Lockì„ ì‹¤ì œ ì½”ë“œì— ì ìš©

```java
// Stock.class
public class Stock {
  // ...
	
  @Version
  private Long version; // ë²„ì „ ì»¬ëŸ¼ ì¶”ê°€
}

// StockRepository.class
public interface StockRepository extends JpaRepository<Stock, Long> {
  // ...
	
  @Lock(LockModeType.OPTIMISTIC)
  @Query("select s from Stock s where s.id = :id")
  Stock findByIdWithOptimisticLock(Long id);
}

// OptimisticLockStockFacade.class
public class OptimisticLockStockFacade {
  // ...
	
  public void decrease(Long id, Long quantity) throws InterruptedException {
    while(true) {
      try {
        optimisticLockStockService.decrease(id, quantity);
        break;
      } catch (Exception e) {
        Thread.sleep(50);
      }
    }
  }
}

```

- ë³„ë„ì˜ ë½(Lock)ì„ ì¡ì§€ ì•Šê¸° ë•Œë¬¸ì— ë¹„ë‚™ê´€ì  ë½ë³´ë‹¤ ì„±ëŠ¥ ìƒ ì´ì ì´ ìˆìŠµë‹ˆë‹¤.

â—ï¸ ì—…ë°ì´íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ, ì¬ì‹œë„ ë¡œì§ì„ ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. 

ğŸ’¡Â ì¼ë°˜ì ìœ¼ë¡œ **ë°ì´í„° ê²½í•©ì´ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ì§€ ì•Šì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë  ë•Œ ì í•©í•œ ë°©ì‹**ì…ë‹ˆë‹¤.ğŸ’¡

</br>

### 2-3. Named Lock(ë„¤ì„ë“œ ë½) í™œìš©í•˜ê¸°

**ì´ë¦„ì„ ê°€ì§„ metadata locking**ì…ë‹ˆë‹¤. (ì‹¤ì œ ë ˆì½”ë“œë¥¼ ë½ âŒ) ë„¤ì„ë“œ ë½ì„ íšë“í•œ í›„ í•´ì œí•  ë•Œê¹Œì§€ ë‹¤ë¥¸ ì„¸ì…˜ì€ ë½ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ì˜í•  ì ì€ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œ, ë½ì´ ìë™ìœ¼ë¡œ í•´ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë³„ë„ì˜ ëª…ë ¹ì–´ë¡œ í•´ì œë¥¼ ìˆ˜í–‰í•˜ê±°ë‚˜ ì„ ì  ì‹œê°„ì´ ëë‚˜ì•¼ í•´ì œë©ë‹ˆë‹¤)

```java
// NamedLockRepository.class
@Repository
public class NamedLockRepository {
  private final DataSource dataSource;

  public NamedLockRepository(DataSource dataSource) {
    this.dataSource = dataSource;
  }

  // Named Lock íšë“
  public boolean getLock(String key) {
    String sql = "SELECT GET_LOCK(?, 3)"; // 3ì´ˆ ë™ì•ˆ ëŒ€ê¸°
    try (Connection connection = dataSource.getConnection();
      PreparedStatement pstmt = connection.prepareStatement(sql)) {
      pstmt.setString(1, key);
      try (ResultSet rs = pstmt.executeQuery()) {
        if (rs.next()) {
          return rs.getInt(1) == 1; // 1ì´ë©´ ë½ íšë“ ì„±ê³µ
        }
      }
    } catch (SQLException e) {
      throw new RuntimeException("Failed to acquire lock", e);
    }
    return false;
  }
  
  // Named Lock í•´ì œ
  public void releaseLock(String key) {
    String sql = "SELECT RELEASE_LOCK(?)";
    try (Connection connection = dataSource.getConnection();
      PreparedStatement pstmt = connection.prepareStatement(sql)) {
      pstmt.setString(1, key);
      pstmt.executeQuery();
    } catch (SQLException e) {
      throw new RuntimeException("Failed to release lock", e);
    }
  }
}

// NamedLockStockFacade.class
public class NamedLockStockFacade {
  // ...
	
  @Transacional // StockServiceì˜ decreaseì˜ íŠ¸ëœì­ì…˜ í”„ë¡œíŒŒê²Œì´ì…˜ì„ ë³€ê²½(REQUIRES_NEW)
  public void decrease(Long id, Long quantity) {
    String lockKey = "stock_" + id;
		
    boolean acquired = namedLockRepository.getLock(lockKey); // ë§Œì•½ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë½ì„ ì ìœ  ì¤‘ì´ë©´ 3ì´ˆ ê°„ í•´ì œë¥¼ ê¸°ë‹¤ë¦¬ê³  ì‹¤íŒ¨
    if(!acquired) {
      throw new RuntimeException("Failed to acquire lock for key: " + lockKey);
    }
		
    try {        
      stockService.decrease(id, quantity);
    } finally {
      namedLockRepository.releaseLock(id.toString());
    }
  }
}
```

- ë¹„ë‚™ê´€ì  ë½ì€ íƒ€ì„ì•„ì›ƒì„ êµ¬í˜„í•˜ê¸° í˜ë“¤ì§€ë§Œ, ë„¤ì„ë“œ ë½ì€ íƒ€ì„ì•„ì›ƒì„ ì†ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â—ï¸ íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œ ë½ í•´ì œ, ì„¸ì…˜ ê´€ë¦¬ë¥¼ ì˜ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

â—ï¸ ì»¤ë„¥ì…˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ê¸°ì¡´ JPA ë°ì´í„° ì†ŒìŠ¤ì™€ ë³„ê°œë¡œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ë¶„ë¦¬í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

</br>

## í•´ê²° ë°©ë²• 3. Redis ì´ìš©í•´ë³´ê¸°

ë¶„ì‚°ë½ì„ êµ¬í˜„í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëŒ€í‘œì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” Lettuce, Redissonì´ ìˆìŠµë‹ˆë‹¤.

### 3-1. Lettuce

- `setnx`(set if not exist) ëª…ë ¹ì–´ë¥¼ í™œìš©í•˜ì—¬ ë¶„ì‚°ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ìŠ¤í•€ ë½ ë°©ì‹ì´ê¸° ë•Œë¬¸ì— ì¬ì‹œë„ ë¡œì§ì„ ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

> **ìŠ¤í•€ ë½**
ìì›ì´ í•´ì œë  ë•Œê¹Œì§€ ë°˜ë³µì ìœ¼ë¡œ í™•ì¸(**polling**)í•˜ë©´ì„œ ë½ì„ íšë“í•˜ë ¤ê³  ì‹œë„í•˜ëŠ” ë½ ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.
**ìì›ì´ ì ê²¨ìˆë‹¤ë©´, ìŠ¤ë ˆë“œëŠ” ëŒ€ê¸°í•˜ì§€ ì•Šê³ , ê³„ì†í•´ì„œ ë½ì´ í’€ë ¸ëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤(Busy Waiting)
> 
> - ìŠ¤ë ˆë“œë¥¼ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜í•˜ì§€ ì•Šì•„ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì„ ì ˆì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> - ìŠ¤ë ˆë“œê°€ ë½ì„ ì–»ì„ ë•Œê¹Œì§€ CPUë¥¼ ê³„ì† ì ìœ í•˜ë¯€ë¡œ, ìì›ì´ ì˜¤ë«ë™ì•ˆ ì ê²¨ ìˆìœ¼ë©´ CPUë¥¼ ë‚­ë¹„í•˜ê²Œ ë©ë‹ˆë‹¤.

### Lettuceë¥¼ ì‹¤ì œ ì½”ë“œì— ì ìš©

- spring-boot-starter-data-redis ì˜ì¡´ì„± ì¶”ê°€í•˜ê¸°

```java
// RedisLockRepository.class
@Component
public class RedisLockRepository {
  private RedisTemplate<String, String> redisTemplate;
	
  // ...

  public Boolean lock(Long key) {
    return redisTemplate
            .opsForValue()
            .setIfAbsent(generateKey(key), "lock");
  }
	
  public Boolean unlock(Long key) {
    return redisTemplate.delete(generateKey(key));
  }
}

// LettuceLcokStockFacade.class
public class LettuceLcokStockFacade {
  // ...
	
  public void decrease(Long id, Long quantity) throws InterruptedException {
    while(!redisLockRepository.lock(id)) {
      Thread.sleep(100); // ì¬ì‹œë„ì— í…€ì„ ë‘ê³ , ë ˆë””ìŠ¤ë¡œ ê°€ëŠ” ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•œ ì¥ì¹˜
    }
		
    try { 
      stockService.decrease(id, quantity);
    } finally {
      redisLockRepository.unlock(id);
    }
  }
}
```

- spring-boot-starter-data-redisì— ë‚´ì¥ë˜ì–´ ìˆìœ¼ë©°, êµ¬í˜„ì´ ê°„ë‹¨í•©ë‹ˆë‹¤.
- ìŠ¤í•€ ë½ ë°©ì‹ì´ê¸° ë•Œë¬¸ì— ë™ì‹œì— ë§ì€ ìŠ¤ë ˆë“œê°€ lock íšë“ì„ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœë¼ë©´ ë ˆë””ìŠ¤ì— ë¶€í•˜ê°€ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</br>

### 3-2. Redisson

- Pub/Sub (ë°œí–‰ê³¼ êµ¬ë…) ê¸°ë°˜ìœ¼ë¡œ ë¶„ì‚°ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì±„ë„ì„ ë§Œë“¤ê³ , ë½ì„ ì ìœ  ì¤‘ì¸ ìŠ¤ë ˆë“œê°€ ë½ì„ íšë“í•˜ê¸° ìœ„í•´ ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œë“¤ì—ê²Œ ë½ í•´ì œë¥¼ ì•Œë ¤ì£¼ë©´, ì•ˆë‚´ë¥¼ ë°›ì€ ìŠ¤ë ˆë“œê°€ ë½ íšë“ì„ ì‹œë„í•©ë‹ˆë‹¤.
- ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì¬ì‹œë„ ë¡œì§ì„ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

### Redissonë¥¼ ì‹¤ì œ ì½”ë“œì— ì ìš©

- ì¶”ê°€ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš” (ğŸ”—Â [ë§í¬](https://mvnrepository.com/artifact/org.redisson/redisson-spring-boot-starter/3.37.0))

```java
// RedissonLcokStockFacade.class
public class RedissonLcokStockFacade {
  private RedissonClient redissonClient;
	
  // ...
	
  public void decrease(Long id, Long quantity) throws InterruptedException {
    RLock lock = redissonClient.getLock(id.toString());
		
    try { 
      boolean avaliable = lock.tryLock(10, 1, TimeUnit.SECONDS); // 10ì´ˆ ë™ì•ˆ ë½ íšë“ ì‹œë„, 1ì´ˆê°„ ì ìœ í•  ê²ƒ!

      if(!avaliable) {
        System.out.println("lock íšë“ ì‹¤íŒ¨");
        return;
      }

      stockService.decrease(id, quantity);
    } catch (InterruptedException e) {
      throw new RuntimeException(e);
    } finally {
      lock.unlock();
    }
  }
}
```

- Pub/Sub ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì— ë ˆë””ìŠ¤ì— ë¶€í•˜ë¥¼ ì¤„ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë½ íšë“ ì¬ì‹œë„ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
- êµ¬í˜„ì´ ì¡°ê¸ˆ ë³µì¡í•˜ê³ , ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.

ğŸ’¡Â ì¬ì‹œë„ê°€ í•„ìš”í•˜ì§€ ì•Šì€ Lockì€ lettuce, ì¬ì‹œë„ê°€ í•„ìš”í•œ ê²½ìš°ì—ëŠ” redissonì„ í™œìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. 

<br>

ğŸ¤”Â MySQLì„ ì¨ì•¼ í• ê¹Œ? Redisë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?

- ì´ë¯¸ MySQLì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, ë³„ë„ì˜ **ë¹„ìš©**ì—†ì´ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
- Redis ë°©ì‹ì´ MySQL ë°©ì‹ë³´ë‹¤ **ì„±ëŠ¥**ì´ ì¢‹ìŠµë‹ˆë‹¤.
- í•˜ì§€ë§Œ MySQL ë°©ì‹ë„ ì–´ëŠ ì •ë„ì˜ íŠ¸ë˜í”½ê¹Œì§€ëŠ” ë¬¸ì œì—†ì´ í™œìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
